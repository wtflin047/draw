<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹‰éœ¸æ©Ÿ</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background-color: #282c34;
            color: #fff;
            height: 100vh;
            justify-content: center;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 36px;
            color: #ffcc00;
        }

        #slotMachine {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .reel {
            width: 80px;
            height: 160px;
            overflow: hidden;
            border: 5px solid #ffcc00;
            border-radius: 10px;
            text-align: center;
            font-size: 32px;
            background-color: #333;
            color: #ffcc00;
            position: relative;
        }

        .reel div {
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: spin 1s linear infinite;
        }

        .reel span {
            height: 60px;
            line-height: 60px;
            font-family: Arial, sans-serif;
        }

        @keyframes spin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-600px); }
        }

        button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #ffcc00;
            color: #282c34;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #e6b800;
        }
    </style>
</head>
<body>
    <h1>æ‹‰éœ¸æ©Ÿ</h1>
    <div id="slotMachine">
        <div class="reel"><div id="reel1"></div></div>
        <div class="reel"><div id="reel2"></div></div>
        <div class="reel"><div id="reel3"></div></div>
    </div>
    <button onclick="toggleSpin()">é–‹å§‹</button>

    <!-- éŸ³æ•ˆ -->
    <audio id="dingSound" src="ding.mp3"></audio>
    <audio id="winSound" src="win.mp3"></audio>

    <script>
        const names = [
            "æå®—ç©", "é™³æ˜±ç’‡", "æ¥Šå‡±å‚‘", "éƒ­å®¶èŒµ", "é™³å½¥å»·", "é™³ä¿¡å®", "æ—å¦¤ç¶º", "æ—ã›„å©·",
            "é»æ›¸å®", "å³å®—ç’‹", "æ—å£«æ¬½", "å²å¯éƒ", "é¡æš–çœŸ", "æ›¾æ•¬å¾·", "å¼µæ™ºçµ¢", "ç›§é³³ç ",
            "éƒ­ç¾½åº­", "é™³è‘³", "åŠ‰å®—æ³°", "æ›¾æ›¼è±", "é¾å®›æ¨º", "é»ƒè‡´å´´", "ç›§æŸ”æ¨º", "æ–½æ–‡è¯",
            "è¨±å­£ç›ˆ", "é»ƒå½¥åš", "è‘‰å€©å¦", "è¬å­Ÿåº­", "ç¿ç‘ç³", "é»ƒå¯æ¬£", "æ—æ›‰å›", "åŠ‰èŠèŠ¸",
            "é»ƒè¶³å¯§", "é‚±å±•æ¥­", "å‘¨æ›¸ç·¯", "åŠ‰å½¥ä¼¯", "é»ƒç€å„€", "æ—ä½©è“‰"
        ];
		
		const selectedCounts = {};  // ç”¨ä¾†è¿½è¸ªæ¯å€‹åå­—çš„å‡ºç¾æ¬¡æ•¸
		// åˆå§‹åŒ–é¸æ“‡æ¬¡æ•¸è¨ˆæ•¸å™¨
		names.forEach(name => selectedCounts[name] = 0);

        const symbols = ["â˜…", "7", "ğŸ’", "BAR", "ğŸ’°"]; // ä½¿ç”¨ç¬¦è™Ÿæ¨£å¼çš„BAR
        const specialCombos = [
            ["â˜…", "â˜…", "â˜…"],
            ["7", "7", "7"],
            ["ğŸ’", "ğŸ’", "ğŸ’"],
            ["BAR", "BAR", "BAR"],
            ["ğŸ’°", "ğŸ’°", "ğŸ’°"]
        ]; // ç‰¹æ®Šçµ„åˆï¼š777ã€BAR BAR BARã€éŒ¢éŒ¢éŒ¢
        let isSpinning = false;
        let selectedName = "";
        let dingInterval;
        let speed = 100; // åˆå§‹è½‰å‹•é€Ÿåº¦
        const dingSound = document.getElementById("dingSound");
        const winSound = document.getElementById("winSound");

        function getRandomValue(min, max, isDouble = false) {
			const array = new Uint32Array(1);
			window.crypto.getRandomValues(array);
			if (isDouble) {
				// è¿”å›æµ®é»æ•¸
				return min + (array[0] / 0xFFFFFFFF) * (max - min);
			} else {
				// è¿”å›æ•´æ•¸
				return min + (array[0] % (max - min + 1));
			}
		}
		
		// æ ¹æ“šå‡ºç¾æ¬¡æ•¸å‹•æ…‹èª¿æ•´æ¬Šé‡ä¸¦é¸æ“‡åå­—
		function getWeightedRandomName() {
			const weightedNames = [];

			// æ ¹æ“šå‡ºç¾æ¬¡æ•¸è¨ˆç®—æ¬Šé‡ï¼Œå‡ºç¾æ¬¡æ•¸è¶Šå¤šæ¬Šé‡è¶Šä½
			names.forEach(name => {
				const weight = Math.max(1, 5 - selectedCounts[name]); // å‡ºç¾æ¬¡æ•¸è¶Šå¤šï¼Œæ¬Šé‡è¶Šä½
				for (let i = 0; i < weight; i++) {
					weightedNames.push(name);
				}
			});

			// éš¨æ©Ÿé¸æ“‡ä¸€å€‹åå­—
			const selectedName = weightedNames[getRandomValue(0, weightedNames.length - 1)];
			// é¸ä¸­å¾Œå¢åŠ è©²åå­—çš„å‡ºç¾æ¬¡æ•¸
			selectedCounts[selectedName]++;
			
			return selectedName;
		}
		
        function getUniqueCharacters(reelId) {
			let characters;
			if (reelId === 1) {
				characters = names.map(name => name[0]);
			} else if (reelId === 2) {
				characters = names.map(name => name[1] || symbols[getRandomValue(0, symbols.length - 1)]);
			} else {
				characters = names.map(name => name[name.length - 1]);
			}

			// éæ¿¾ç©ºå­—ç¬¦ä¸¦å»é‡
			let uniqueChars = [...new Set(characters.filter(char => char))];
            
            // éš¨æ©Ÿæ’å…¥ç¬¦è™Ÿï¼Œé¿å…æ²è»¸å½¢æˆå®Œæ•´åå­—
            for (let i = 0; i < uniqueChars.length; i += 3) {
                uniqueChars.splice(i, 0, symbols[getRandomValue(0, symbols.length - 1)]);
            }

            return uniqueChars;
        }

        function startReel(reel, reelId) {
            reel.innerHTML = '';  // æ¸…ç©ºæ²è»¸å…§å®¹
            const characters = getUniqueCharacters(reelId);

            for (let i = 0; i < 8; i++) {
                characters.forEach(char => {
                    const span = document.createElement("span");
                    span.textContent = char;
                    reel.appendChild(span);
                });
            }

            reel.style.animation = `spin ${speed / 1000}s linear infinite`;
        }

        function startSpin() {
            document.querySelectorAll('.reel div').forEach((reel, index) => {
                startReel(reel, index + 1);
            });
        }

        function playDingSound() {
            clearInterval(dingInterval); // æ¸…é™¤ä»»ä½•å…ˆå‰çš„é–“éš”
			dingInterval = setInterval(() => {
                dingSound.currentTime = 0;
                dingSound.play();
            }, speed); // æ¯150æ¯«ç§’æ’­æ”¾ä¸€æ¬¡å®è²
        }
		
		function graduallySlowDown() {
            // åœæ­¢å®è²ä¸¦ä¾æ¬¡åœä¸‹æ²è»¸
            let stopDelay = 0;
            [1, 2, 3].forEach((reelId, index) => {
                const char = reelId === 1 ? selectedName[0] : 
                             reelId === 2 ? selectedName[1] || symbols[getRandomValue(0, symbols.length - 1)] : 
                             selectedName[selectedName.length - 1];
                    
                setTimeout(() => {
                    stopReel(reelId, char);
                    if (index === 2) {
                        winSound.play(); // æ’­æ”¾ä¸­çéŸ³æ•ˆ
                        isSpinning = false;
                    }
                }, stopDelay);
				if (index === 0) {
					stopDelay += getRandomValue(600, 800);
				} else if (index === 1) {
					stopDelay += getRandomValue(600, 900);
				} else if (index === 2) {
					stopDelay += getRandomValue(600, 1000);
				}
             });
        }

        function stopReel(reelId, char) {
            const reel = document.getElementById(`reel${reelId}`);
            const children = Array.from(reel.children);
            reel.style.animation = "none"; // åœæ­¢æ»¾å‹•å‹•ç•«
			
			// æ‰¾åˆ°å­—ç¬¦åœ¨æ²è»¸ä¸­çš„ä½ç½®ï¼Œä¸¦ç¢ºä¿ä¸æ˜¯ç¬¬ä¸€å€‹
			let targetIndex = children.findIndex(child => child.textContent === char);
			
			// å¦‚æœå­—ç¬¦åœ¨ç¬¬ä¸€å€‹ä½ç½®ï¼Œé¸æ“‡ä¸‹ä¸€å€‹å‡ºç¾çš„ä½ç½®
			if (targetIndex < 4 && children.length > 1) {
				targetIndex = children.findIndex((child, idx) => child.textContent === char && idx > 0);
			}
			
            const offset = -(targetIndex - 1) * 60; // åç§»é‡ï¼Œè®“é¸ä¸­çš„å­—ç¬¦åœ¨ä¸­é–“
            reel.style.transform = `translateY(${offset}px)`;
			
			clearInterval(dingInterval); // åœæ­¢å®è²
			dingSound.currentTime = 0;
            dingSound.play(); // åœæ­¢æ™‚æ’­æ”¾å®è²
        }

        function toggleSpin() {
            if (!isSpinning) {
                speed = 100; // é‡ç½®é€Ÿåº¦
                // é–‹å§‹æ’­æ”¾å®è²éŸ³æ•ˆ
                playDingSound();
                isSpinning = true;
				
				// 5% æ©Ÿç‡è§¸ç™¼ç‰¹æ®Šçµ„åˆ
                if (getRandomValue(0, 1, true) < 0.05) {
                    selectedName = specialCombos[getRandomValue(0, specialCombos.length - 1)];
                } else {
					selectedName = getWeightedRandomName(); // ä½¿ç”¨åŠ æ¬Šéš¨æ©Ÿé¸æ“‡;
                }
                startSpin();
            } else {
                graduallySlowDown(); // é€æ¼¸æ¸›æ…¢
            }
        }
    </script>
</body>
</html>
